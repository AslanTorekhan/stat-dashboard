<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–ª–∞–Ω –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ & –î–∏–Ω–∞–º–∏–∫–∞</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f6f9;
            --white: #ffffff;
            --green: #28a745;
            --yellow: #ffc107;
            --grey: #6c757d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        }

        /* --- –®–ê–ü–ö–ê --- */
        .app-header {
            background: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-area img {
            height: 45px;
            width: auto;
        }

        .refresh-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        /* --- –í–ö–õ–ê–î–ö–ò (–ö–û–ù–¢–ï–ù–¢) --- */
        .tab-content {
            display: none;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- –§–ò–õ–¨–¢–† –û–¢–†–ê–°–õ–ï–ô (–ë–µ–≥—É–Ω–æ–∫) --- */
        .industry-scroll-wrapper {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }

        .industry-btn {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 8px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .industry-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ (–ú–µ—Å—è—Ü—ã) --- */
        .months-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .month-btn {
            padding: 10px 5px;
            background: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
        }
        .month-btn.active {
            border-color: var(--primary-color);
            background-color: #e7f1ff;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* --- –°–ü–ò–°–û–ö –î–ò–ù–ê–ú–ò–ö --- */
        .dynamic-card {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 5px solid transparent;
        }

        .date-col {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }

        .info-col {
            flex-grow: 1;
        }

        .info-col h4 {
            margin: 0 0 5px 0;
            font-size: 15px;
            font-weight: 500;
        }

        .info-col p {
            margin: 0;
            font-size: 12px;
            color: #888;
        }

        /* –¶–≤–µ—Ç–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ */
        .status-planted { border-left-color: var(--green); }
        .status-planted .date-col { color: var(--green); }
        .status-planted h4 { color: var(--green); text-decoration: underline; }

        .status-work { border-left-color: var(--yellow); }
        .status-work .date-col { color: var(--yellow); }
        
        .status-future { border-left-color: var(--grey); }
        .status-future .date-col { color: var(--grey); }
        .status-future a { pointer-events: none; text-decoration: none; color: #333; }

        .summary-stats {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
            color: #666;
        }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (–ù–ê–í–ò–ì–ê–¶–ò–Ø) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            display: flex;
            border-top: 1px solid #ddd;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px;
            color: #999;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary-color);
            font-weight: bold;
            border-top: 3px solid var(--primary-color);
        }

    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-area">
            <img src="2022 –Ω–æ–≤—ã–π –ª–æ–≥–æ—Ç–∏–ø –ë–ù–° 3 –≤–∞—Ä–∏–∞–Ω—Ç.png" alt="QAZSTAT" onerror="this.style.display='none'">
            <span style="font-weight:bold; margin-left:10px; vertical-align: middle;">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</span>
        </div>
        <button class="refresh-btn" onclick="forceUpdate()">‚Üª</button>
    </header>

    <div id="tab-plan" class="tab-content">
        <h3 style="text-align:center; color:#888;">–ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–û—Å–Ω–æ–≤–Ω–æ–π)</h3>
        <p style="text-align:center;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–Ω —Ä–∞–±–æ—Ç.</p>
        <div style="text-align:center; margin-top:20px;">
            <small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–î–∏–Ω–∞–º–∏–∫–∞" –≤–Ω–∏–∑—É</small>
        </div>
    </div>

    <div id="tab-dynamic" class="tab-content active">
        
        <div class="industry-scroll-wrapper" id="industry-filter">
            </div>

        <div class="months-grid" id="months-grid">
            </div>

        <div class="summary-stats" id="summary-text">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <div id="dynamics-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="switchTab('plan')">üìã –ü–ª–∞–Ω —Ä–∞–±–æ—Ç</div>
        <div class="nav-item active" onclick="switchTab('dynamic')">üìä –î–∏–Ω–∞–º–∏–∫–∞</div>
    </nav>

    <script>
        // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –î–ò–ù–ê–ú–ò–ö–ò
        const DYNAMIC_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQYOTGJUSzQQPVq-gzBIdTV_JLH7ySx_PltpdsEMsaaCVFjLmLaYEpeMAg3QSU17XgYIdRo_sZA50RM/pub?output=csv';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let allData = [];
        let currentMonth = new Date().getMonth();
        let currentIndustry = '–í—Å–µ';
        const monthNames = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderMonths();
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ö–Ω–æ–ø–∫–∞ –≤ —É–≥–ª—É)
        function forceUpdate() {
            if('caches' in window){
                caches.keys().then(function(names) {
                    for (let name of names) caches.delete(name);
                });
            }
            location.reload(true);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –ø–æ —Ç–µ–∫—Å—Ç—É (—É–ø—Ä–æ—â–µ–Ω–Ω–æ) –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—É.
            // –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥ –¥–ª—è –¥–µ–º–æ:
            const items = document.querySelectorAll('.nav-item');
            if(tabName === 'plan') items[0].classList.add('active');
            else items[1].classList.add('active');
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ü–∞—Ä—Å–∏–Ω–≥ ---
        function loadData() {
            Papa.parse(DYNAMIC_CSV_URL, {
                download: true,
                header: false, // –£ –≤–∞—Å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø—Ä–æ—â–µ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
                skipEmptyLines: true,
                complete: function(results) {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (–∑–∞–≥–æ–ª–æ–≤–∫–∏)
                    const rawRows = results.data.slice(1);
                    
                    // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–æ–ª–±—Ü–æ–≤: 
                    // [0] –û—Ç—Ä–∞—Å–ª—å, [1] –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, [4] –î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏, [5] –°—Å—ã–ª–∫–∏
                    allData = rawRows.map(row => ({
                        industry: row[0] ? row[0].trim() : '–û–±—â–µ–µ',
                        name: row[1],
                        dateStr: row[4],
                        link: row[5] ? row[5].trim() : ''
                    })).filter(item => item.name && item.dateStr); // –£–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä

                    initIndustryFilter();
                    renderList();
                },
                error: function(err) {
                    document.getElementById('summary-text').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
                }
            });
        }

        // --- –õ–æ–≥–∏–∫–∞ –§–∏–ª—å—Ç—Ä–∞ –û—Ç—Ä–∞—Å–ª–µ–π ---
        function initIndustryFilter() {
            const container = document.getElementById('industry-filter');
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Ä–∞—Å–ª–∏
            const industries = ['–í—Å–µ', ...new Set(allData.map(d => d.industry))];
            
            container.innerHTML = '';
            
            industries.forEach(ind => {
                const btn = document.createElement('span');
                btn.className = `industry-btn ${ind === currentIndustry ? 'active' : ''}`;
                btn.innerText = ind;
                btn.onclick = () => {
                    // –°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ç—Ä–∞—Å–ª–∏
                    currentIndustry = ind;
                    document.querySelectorAll('.industry-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderList();
                };
                container.appendChild(btn);
            });
        }

        // --- –õ–æ–≥–∏–∫–∞ –ö–∞–ª–µ–Ω–¥–∞—Ä—è ---
        function renderMonths() {
            const container = document.getElementById('months-grid');
            container.innerHTML = '';
            monthNames.forEach((name, idx) => {
                const btn = document.createElement('div');
                btn.className = `month-btn ${idx === currentMonth ? 'active' : ''}`;
                btn.innerText = name;
                btn.onclick = () => {
                    currentMonth = idx;
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderList();
                };
                container.appendChild(btn);
            });
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        function parseDate(dateStr) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç (–æ–±—ã—á–Ω–æ –≤ –≥—É–≥–ª —Ç–∞–±–ª–∏—Ü–∞—Ö —ç—Ç–æ –î–î.–ú–ú.–ì–ì–ì–ì –∏–ª–∏ –ì–ì–ì–ì-–ú–ú-–î–î)
            let parts = dateStr.split('.');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        function getStatus(item, dateObj) {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å (–¥–ª–∏–Ω–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤) -> –ó–µ–ª–µ–Ω—ã–π (–ü–æ—Å–∞–∂–µ–Ω–æ)
            if (item.link && item.link.length > 5) return 'planted';
            
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –Ω–æ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –ø—Ä–æ—à–ª–∞ -> –ñ–µ–ª—Ç—ã–π (–í —Ä–∞–±–æ—Ç–µ)
            if (dateObj <= today) return 'work';
            
            // –ò–Ω–∞—á–µ -> –°–µ—Ä—ã–π (–†–∞–Ω–æ)
            return 'future';
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –°–ø–∏—Å–∫–∞ ---
        function renderList() {
            const listContainer = document.getElementById('dynamics-list');
            const summaryContainer = document.getElementById('summary-text');
            listContainer.innerHTML = '';

            // 1. –§–∏–ª—å—Ç—Ä –ø–æ –ú–µ—Å—è—Ü—É
            let filtered = allData.filter(item => {
                const d = parseDate(item.dateStr);
                return d.getMonth() === currentMonth;
            });

            // 2. –§–∏–ª—å—Ç—Ä –ø–æ –û—Ç—Ä–∞—Å–ª–∏ (–µ—Å–ª–∏ –Ω–µ "–í—Å–µ")
            if (currentIndustry !== '–í—Å–µ') {
                filtered = filtered.filter(item => item.industry === currentIndustry);
            }

            // 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
            filtered.sort((a, b) => parseDate(a.dateStr) - parseDate(b.dateStr));

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            let stats = { planted: 0, work: 0, future: 0 };

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
            } else {
                filtered.forEach(item => {
                    const dateObj = parseDate(item.dateStr);
                    const status = getStatus(item, dateObj);
                    stats[status]++;

                    const card = document.createElement('div');
                    card.className = `dynamic-card status-${status}`;
                    
                    // –°—Å—ã–ª–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                    const nameHtml = status === 'planted' 
                        ? `<a href="${item.link}" target="_blank">${item.name}</a>` 
                        : item.name;

                    card.innerHTML = `
                        <div class="date-col">${dateObj.getDate()}</div>
                        <div class="info-col">
                            <h4>${nameHtml}</h4>
                            <p>${item.industry}</p>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
            summaryContainer.innerHTML = `
                –í—Å–µ–≥–æ: <b>${filtered.length}</b> &nbsp;|&nbsp; 
                <span style="color:var(--green)">–ì–æ—Ç–æ–≤–æ: ${stats.planted}</span> &nbsp;|&nbsp; 
                <span style="color:var(--yellow)">–í —Ä–∞–±–æ—Ç–µ: ${stats.work}</span>
            `;
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ñ—Ñ–ª–∞–π–Ω)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>