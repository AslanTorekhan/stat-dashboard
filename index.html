<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–ª–∞–Ω & –î–∏–Ω–∞–º–∏–∫–∞ 2026</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f4f6f9;
            --white: #ffffff;
            --green: #28a745;
            --yellow: #ffc107;
            --grey: #6c757d;
            --red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: #333;
            padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –º–µ–Ω—é */
            overscroll-behavior-y: none; /* –û—Ç–∫–ª—é—á–∞–µ–º "—Ä–µ–∑–∏–Ω–∫—É" */
        }

        /* --- –®–ê–ü–ö–ê --- */
        .app-header {
            background: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo-area img { height: 40px; width: auto; }
        .refresh-btn { background: none; border: 1px solid #ddd; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 16px; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–í–ö–õ–ê–î–ö–ò) --- */
        .tab-content { display: none; height: calc(100vh - 140px); }
        .tab-content.active { display: block; }
        
        /* === –°–¢–ò–õ–ò –î–õ–Ø –ü–õ–ê–ù–ê (–ö–ê–ù–ë–ê–ù) === */
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ */
        .kanban-board {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            height: 100%;
            padding: 10px;
            gap: 15px;
        }
        
        .kanban-column {
            min-width: 85vw; /* –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º 1 –∫–æ–ª–æ–Ω–∫–∞ –ø–æ—á—Ç–∏ –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
            scroll-snap-align: center;
            background: #eef0f5;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        /* –ù–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –∏ –ü–ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ 3 –∫–æ–ª–æ–Ω–∫–∏ —Å—Ä–∞–∑—É */
        @media (min-width: 768px) {
            .kanban-column { min-width: 300px; flex: 1; }
        }

        .column-header {
            padding: 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: inherit;
            border-radius: 12px 12px 0 0;
            z-index: 10;
        }

        .header-today { color: var(--red); border-top: 4px solid var(--red); }
        .header-wait { color: var(--yellow); border-top: 4px solid var(--yellow); }
        .header-done { color: var(--green); border-top: 4px solid var(--green); }

        .column-body {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ */
        .task-card {
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
        }
        .task-title { font-weight: 600; font-size: 15px; margin-bottom: 5px; line-height: 1.3; }
        .task-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; align-items: center; }
        .task-date { display: inline-flex; align-items: center; gap: 4px; }
        .edit-btn { background: none; border: none; font-size: 16px; cursor: pointer; padding: 5px; opacity: 0.6; }
        
        /* === –°–¢–ò–õ–ò –î–õ–Ø –î–ò–ù–ê–ú–ò–ö–ò === */
        .dynamic-container { padding: 15px; overflow-y: auto; height: 100%; }
        
        .industry-scroll-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 10px; }
        .industry-btn { display: inline-block; padding: 6px 14px; margin-right: 6px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .industry-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        .months-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; }
        .month-btn { padding: 8px 2px; background: #fff; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 12px; cursor: pointer; }
        .month-btn.active { background-color: #e7f1ff; color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .summary-stats { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; text-align: center; color: #666; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .dynamic-card { background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; border-left: 4px solid #ccc; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .date-badge { font-weight: bold; font-size: 16px; width: 35px; text-align: center; margin-right: 10px; }
        .dynamic-info h4 { margin: 0 0 3px 0; font-size: 14px; font-weight: 500; }
        .dynamic-info p { margin: 0; font-size: 11px; color: #999; }
        .dynamic-info a { color: inherit; text-decoration: underline; }

        .status-planted { border-left-color: var(--green); } .status-planted .date-badge { color: var(--green); } .status-planted a { color: var(--green); }
        .status-work { border-left-color: var(--yellow); } .status-work .date-badge { color: var(--yellow); }
        .status-future { border-left-color: var(--grey); } .status-future .date-badge { color: var(--grey); } .status-future a { pointer-events: none; text-decoration: none; color: #333; }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 2000; height: 60px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #999; font-size: 11px; cursor: pointer; }
        .nav-item span { font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-area">
            <img src="logo.jpg" alt="QAZSTAT" onerror="this.style.display='none'">
            <span style="font-weight:bold; margin-left:8px; font-size:14px;">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç 2026</span>
        </div>
        <button class="refresh-btn" onclick="forceUpdate()">‚Üª</button>
    </header>

    <div id="tab-plan" class="tab-content active">
        <div class="kanban-board">
            
            <div class="kanban-column">
                <div class="column-header header-today">
                    üî• –í —Ä–∞–±–æ—Ç–µ <span id="count-today" style="opacity:0.6">0</span>
                </div>
                <div class="column-body" id="col-today">
                    </div>
            </div>

            <div class="kanban-column">
                <div class="column-header header-wait">
                    ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ <span id="count-wait" style="opacity:0.6">0</span>
                </div>
                <div class="column-body" id="col-wait"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header header-done">
                    ‚úÖ –ì–æ—Ç–æ–≤–æ <span id="count-done" style="opacity:0.6">0</span>
                </div>
                <div class="column-body" id="col-done"></div>
            </div>
        </div>
    </div>

    <div id="tab-dynamic" class="tab-content">
        <div class="dynamic-container">
            <div class="industry-scroll-wrapper" id="industry-filter"></div>
            <div class="months-grid" id="months-grid"></div>
            <div class="summary-stats" id="summary-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="dynamics-list"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('plan', this)">
            <span>üìã</span> –ü–ª–∞–Ω —Ä–∞–±–æ—Ç
        </div>
        <div class="nav-item" onclick="switchTab('dynamic', this)">
            <span>üìä</span> –î–∏–Ω–∞–º–∏–∫–∞
        </div>
    </nav>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyshEU0jIAtxReqbB_1ADIAcG9XiQ3D0c5Lbf_Xteid-oW8Te8-mUqAOrmzcjL7cWpzMA/exec';
        
        // –°—Å—ã–ª–∫–∞ 1: –ü–õ–ê–ù
        const URL_PLAN = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSiUUHVFLpn5WE5zwI7UOCNNz4gjENAX4ahMtDO7f8e_qvUpwTqtaBN0nfUzOU5unXMWvzwU5zhSkB/pub?output=csv';
        // –°—Å—ã–ª–∫–∞ 2: –î–ò–ù–ê–ú–ò–ö–ê
        const URL_DYN = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQYOTGJUSzQQPVq-gzBIdTV_JLH7ySx_PltpdsEMsaaCVFjLmLaYEpeMAg3QSU17XgYIdRo_sZA50RM/pub?output=csv';

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let planData = [];
        let dynData = [];
        let curMonth = new Date().getMonth();
        let curIndustry = '–í—Å–µ';
        const months = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];

        document.addEventListener('DOMContentLoaded', () => {
            loadPlan();
            loadDynamics();
            renderMonths();
        });

        // === 1. –õ–û–ì–ò–ö–ê –ü–õ–ê–ù–ê (3 –∫–æ–ª–æ–Ω–∫–∏) ===
        function loadPlan() {
            Papa.parse(URL_PLAN, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data.slice(1);
                    // –ú–∞–ø–ø–∏–Ω–≥ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º): 0:–ö–∞—Ç–µ–≥–æ—Ä–∏—è, 1:–ò–º—è, 2:–î–∞—Ç–∞, 4:–ö–æ–º–º–µ–Ω—Ç
                    planData = rows.map((r, i) => ({
                        id: i, // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è UI
                        category: r[0],
                        name: r[1],
                        date: r[2], // YYYY-MM-DD
                        comment: r[4]
                    })).filter(i => i.name);
                    
                    distributePlanCards();
                }
            });
        }

        function distributePlanCards() {
            const today = new Date();
            today.setHours(0,0,0,0);

            const cols = { today: [], wait: [], done: [] };

            planData.forEach(task => {
                const d = parseDate(task.date);
                // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–º–µ—Ç–∫–∞ "–í—ã–ø–æ–ª–Ω–µ–Ω–æ" (–Ω–∞–ø—Ä–∏–º–µ—Ä –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ö –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) -> Done
                // –ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ –î–∞—Ç–µ:
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ (–µ—Å–ª–∏ –≤ CSV –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –ø–æ–∫–∞ –ø–æ –¥–∞—Ç–µ)
                // –î–ª—è –¥–µ–º–æ: –µ—Å–ª–∏ –¥–∞—Ç–∞ –≤ –¥–∞–ª–µ–∫–æ–º –ø—Ä–æ—à–ª–æ–º - –≥–æ—Ç–æ–≤–æ, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è - –≤ —Ä–∞–±–æ—Ç–µ
                // (–í —Ä–µ–∞–ª–µ –Ω—É–∂–Ω–æ –ø–æ–ª–µ –°—Ç–∞—Ç—É—Å, –Ω–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä)
                
                if (task.comment && task.comment.toLowerCase().includes('–≥–æ—Ç–æ–≤–æ')) {
                    cols.done.push(task);
                } else if (d < today) {
                     // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –∏–ª–∏ —Å–¥–µ–ª–∞–Ω–æ? –ö–∏–¥–∞–µ–º –≤ "–í —Ä–∞–±–æ—Ç–µ" –∫–∞–∫ —Å—Ä–æ—á–Ω–æ–µ
                     cols.today.push(task); 
                } else if (d.getTime() === today.getTime()) {
                    cols.today.push(task);
                } else {
                    cols.wait.push(task);
                }
            });

            renderColumn('col-today', cols.today, 'count-today');
            renderColumn('col-wait', cols.wait, 'count-wait');
            renderColumn('col-done', cols.done, 'count-done');
        }

        function renderColumn(elId, tasks, countId) {
            const container = document.getElementById(elId);
            document.getElementById(countId).innerText = tasks.length;
            container.innerHTML = '';

            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = 'task-card';
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ DD.MM.YYYY
                const dateVis = task.date ? task.date.split('-').reverse().join('.') : '';
                
                div.innerHTML = `
                    <div class="task-title">${task.name}</div>
                    <div class="task-meta">
                        <span class="task-date">üìÖ ${dateVis}</span>
                        <button class="edit-btn" onclick="openEdit('${task.name}', '${task.date}')">‚úèÔ∏è</button>
                    </div>
                    ${task.comment ? `<div style="font-size:11px; color:#666; margin-top:5px; border-top:1px solid #eee; padding-top:4px;">${task.comment}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function openEdit(name, oldDate) {
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–æ–¥–∞–ª–∫–∞. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ `prompt`
            const newDate = prompt(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É "${name}"?\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É (–ì–ì–ì–ì-–ú–ú-–î–î):`, oldDate);
            if(newDate && newDate !== oldDate) {
                sendUpdateToSheet(name, oldDate, newDate);
            }
        }

        function sendUpdateToSheet(name, oldDate, newDate) {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Apps Script
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è Google Apps Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'change_date',
                    name: name,
                    oldDate: oldDate,
                    newDate: newDate
                })
            }).then(() => {
                alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç.');
            }).catch(e => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
        }


        // === 2. –õ–û–ì–ò–ö–ê –î–ò–ù–ê–ú–ò–ö–ò (–ö–∞–ª–µ–Ω–¥–∞—Ä—å) ===
        function loadDynamics() {
            Papa.parse(URL_DYN, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data.slice(1);
                    dynData = rows.map(r => ({
                        industry: r[0] ? r[0].trim() : '–û–±—â–µ–µ',
                        name: r[1],
                        dateStr: r[4],
                        link: r[5] ? r[5].trim() : ''
                    })).filter(i => i.name && i.dateStr);
                    
                    initIndustryFilter();
                    renderDynList();
                }
            });
        }

        function initIndustryFilter() {
            const cont = document.getElementById('industry-filter');
            const inds = ['–í—Å–µ', ...new Set(dynData.map(d => d.industry))];
            cont.innerHTML = '';
            inds.forEach(ind => {
                const btn = document.createElement('span');
                btn.className = `industry-btn ${ind === curIndustry ? 'active' : ''}`;
                btn.innerText = ind;
                btn.onclick = () => {
                    curIndustry = ind;
                    document.querySelectorAll('.industry-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderDynList();
                };
                cont.appendChild(btn);
            });
        }

        function renderMonths() {
            const cont = document.getElementById('months-grid');
            cont.innerHTML = '';
            months.forEach((m, i) => {
                const btn = document.createElement('div');
                btn.className = `month-btn ${i === curMonth ? 'active' : ''}`;
                btn.innerText = m;
                btn.onclick = () => {
                    curMonth = i;
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderDynList();
                };
                cont.appendChild(btn);
            });
        }

        function renderDynList() {
            const cont = document.getElementById('dynamics-list');
            const stats = document.getElementById('summary-text');
            cont.innerHTML = '';

            let filtered = dynData.filter(item => {
                const d = parseDate(item.dateStr);
                return d.getMonth() === curMonth && (curIndustry === '–í—Å–µ' || item.industry === curIndustry);
            });
            filtered.sort((a,b) => parseDate(a.dateStr) - parseDate(b.dateStr));

            let counts = { planted: 0, work: 0, future: 0 };
            
            if(filtered.length === 0) {
                cont.innerHTML = '<div style="text-align:center;color:#999;padding:20px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            } else {
                filtered.forEach(item => {
                    const d = parseDate(item.dateStr);
                    const status = getDynStatus(item, d);
                    counts[status]++;
                    
                    const el = document.createElement('div');
                    el.className = `dynamic-card status-${status}`;
                    const nameHtml = status === 'planted' 
                        ? `<a href="${item.link}" target="_blank">${item.name}</a>` : item.name;
                    
                    el.innerHTML = `
                        <div class="date-badge">${d.getDate()}</div>
                        <div class="dynamic-info">
                            <h4>${nameHtml}</h4>
                            <p>${item.industry}</p>
                        </div>
                    `;
                    cont.appendChild(el);
                });
            }
            stats.innerHTML = `–í—Å–µ–≥–æ: <b>${filtered.length}</b> | <span style="color:var(--green)">–ì–æ—Ç–æ–≤–æ: ${counts.planted}</span> | <span style="color:var(--yellow)">–í —Ä–∞–±–æ—Ç–µ: ${counts.work}</span>`;
        }

        // === –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò ===
        function parseDate(s) {
            if(!s) return new Date();
            let p = s.split('.'); // –î–î.–ú–ú.–ì–ì–ì–ì
            if(p.length === 3) return new Date(p[2], p[1]-1, p[0]);
            return new Date(s); // –ì–ì–ì–ì-–ú–ú-–î–î
        }

        function getDynStatus(item, d) {
            const today = new Date(); today.setHours(0,0,0,0);
            if(item.link && item.link.length > 5) return 'planted';
            if(d <= today) return 'work';
            return 'future';
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        function forceUpdate() {
            if('caches' in window) caches.keys().then(n => n.forEach(k => caches.delete(k)));
            location.reload(true);
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
