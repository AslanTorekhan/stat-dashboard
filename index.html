<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–ª–∞–Ω –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ & –î–∏–Ω–∞–º–∏–∫–∞</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f6f9;
            --white: #ffffff;
            --green: #28a745;
            --yellow: #ffc107;
            --grey: #6c757d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        }

        /* --- –®–ê–ü–ö–ê --- */
        .app-header {
            background: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-area img {
            height: 45px;
            width: auto;
        }

        .refresh-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        /* --- –ö–û–ù–¢–ï–ù–¢ (–í–ö–õ–ê–î–ö–ò) --- */
        .tab-content {
            display: none;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- –§–ò–õ–¨–¢–† –û–¢–†–ê–°–õ–ï–ô (–ë–µ–≥—É–Ω–æ–∫) --- */
        .industry-scroll-wrapper {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }

        .industry-btn {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 8px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .industry-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ (–ö–Ω–æ–ø–∫–∏ –º–µ—Å—è—Ü–µ–≤) --- */
        .months-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .month-btn {
            padding: 10px 5px;
            background: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
        }
        .month-btn.active {
            border-color: var(--primary-color);
            background-color: #e7f1ff;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* --- –°–í–û–î–ö–ê --- */
        .summary-stats {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
            color: #555;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* --- –°–ü–ò–°–û–ö –ó–ê–î–ê–ß --- */
        .dynamic-card {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 5px solid transparent;
        }

        .date-col {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }

        .info-col {
            flex-grow: 1;
        }

        .info-col h4 {
            margin: 0 0 5px 0;
            font-size: 15px;
            font-weight: 500;
        }

        .info-col p {
            margin: 0;
            font-size: 12px;
            color: #888;
        }

        /* –¶–≤–µ—Ç–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ */
        /* –ó–µ–ª–µ–Ω—ã–π: –ü–æ—Å–∞–∂–µ–Ω–æ (–µ—Å—Ç—å —Å—Å—ã–ª–∫–∞) */
        .status-planted { border-left-color: var(--green); }
        .status-planted .date-col { color: var(--green); }
        .status-planted h4 { color: var(--green); text-decoration: underline; }
        .status-planted a { color: inherit; }

        /* –ñ–µ–ª—Ç—ã–π: –í —Ä–∞–±–æ—Ç–µ (—Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –Ω–æ –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ) */
        .status-work { border-left-color: var(--yellow); }
        .status-work .date-col { color: var(--yellow); }
        
        /* –°–µ—Ä—ã–π: –ë—É–¥—É—â–µ–µ */
        .status-future { border-left-color: var(--grey); }
        .status-future .date-col { color: var(--grey); }
        .status-future a { pointer-events: none; text-decoration: none; color: #333; }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            display: flex;
            border-top: 1px solid #ddd;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px;
            color: #999;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary-color);
            font-weight: bold;
            border-top: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-area">
            <img src="logo.jpg" alt="QAZSTAT" onerror="this.style.display='none'">
            <span style="font-weight:bold; margin-left:10px; font-size: 0.9em;">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</span>
        </div>
        <button class="refresh-btn" onclick="forceUpdate()">‚Üª</button>
    </header>

    <div id="tab-plan" class="tab-content">
        <h3 style="text-align:center; color:#888; margin-top:50px;">–ü–ª–∞–Ω —Ä–∞–±–æ—Ç</h3>
        <p style="text-align:center;">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ–±—â–∏–π –ø–ª–∞–Ω.</p>
        <div style="text-align:center; margin-top:20px;">
            <small>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É <b>–î–∏–Ω–∞–º–∏–∫–∞</b></small>
        </div>
    </div>

    <div id="tab-dynamic" class="tab-content active">
        
        <div class="industry-scroll-wrapper" id="industry-filter">
            </div>

        <div class="months-grid" id="months-grid">
            </div>

        <div class="summary-stats" id="summary-text">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <div id="dynamics-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="switchTab('plan')">üìã –ü–ª–∞–Ω</div>
        <div class="nav-item active" onclick="switchTab('dynamic')">üìä –î–∏–Ω–∞–º–∏–∫–∞</div>
    </nav>

    <script>
        // –°—Å—ã–ª–∫–∞ –Ω–∞ Google CSV
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQYOTGJUSzQQPVq-gzBIdTV_JLH7ySx_PltpdsEMsaaCVFjLmLaYEpeMAg3QSU17XgYIdRo_sZA50RM/pub?output=csv';
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        let allData = [];
        let currentMonth = new Date().getMonth(); // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (0=–Ø–Ω–≤–∞—Ä—å)
        let currentIndustry = '–í—Å–µ';
        const monthNames = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderMonths();
        });

        // 1. –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function forceUpdate() {
            if('caches' in window){
                caches.keys().then(function(names) {
                    for (let name of names) caches.delete(name);
                });
            }
            location.reload(true);
        }

        // 2. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
            const menuIndex = tabName === 'plan' ? 0 : 1;
            document.querySelectorAll('.nav-item')[menuIndex].classList.add('active');
        }

        // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: false, 
                skipEmptyLines: true,
                complete: function(results) {
                    const rawRows = results.data.slice(1); // –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ. –ò–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫:
                    // 0: –û—Ç—Ä–∞—Å–ª—å, 1: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, 4: –î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏, 5: –°—Å—ã–ª–∫–∏
                    allData = rawRows.map(row => ({
                        industry: row[0] ? row[0].trim() : '–û–±—â–µ–µ',
                        name: row[1],
                        dateStr: row[4],
                        link: row[5] ? row[5].trim() : ''
                    })).filter(item => item.name && item.dateStr);

                    initIndustryFilter();
                    renderList();
                },
                error: function(err) {
                    document.getElementById('summary-text').innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ";
                }
            });
        }

        // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –æ—Ç—Ä–∞—Å–ª–µ–π
        function initIndustryFilter() {
            const container = document.getElementById('industry-filter');
            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Ä–∞—Å–ª–∏
            const uniqueIndustries = ['–í—Å–µ', ...new Set(allData.map(d => d.industry))];
            
            container.innerHTML = '';
            
            uniqueIndustries.forEach(ind => {
                const btn = document.createElement('span');
                btn.className = `industry-btn ${ind === currentIndustry ? 'active' : ''}`;
                btn.innerText = ind;
                btn.onclick = () => {
                    currentIndustry = ind; // –ú–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –æ—Ç—Ä–∞—Å–ª—å
                    document.querySelectorAll('.industry-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                };
                container.appendChild(btn);
            });
        }

        // 5. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ—Å—è—Ü–µ–≤
        function renderMonths() {
            const container = document.getElementById('months-grid');
            container.innerHTML = '';
            monthNames.forEach((name, idx) => {
                const btn = document.createElement('div');
                btn.className = `month-btn ${idx === currentMonth ? 'active' : ''}`;
                btn.innerText = name;
                btn.onclick = () => {
                    currentMonth = idx;
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderList();
                };
                container.appendChild(btn);
            });
        }

        // 6. –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã (–î–î.–ú–ú.–ì–ì–ì–ì –∏–ª–∏ –ì–ì–ì–ì-–ú–ú-–î–î)
        function parseDate(dateStr) {
            let parts = dateStr.split('.');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        // 7. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–ó–µ–ª–µ–Ω—ã–π / –ñ–µ–ª—Ç—ã–π / –°–µ—Ä—ã–π)
        function getStatus(item, dateObj) {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // –ï—Å—Ç—å —Å—Å—ã–ª–∫–∞ (–¥–ª–∏–Ω–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤) -> –ó–µ–ª–µ–Ω—ã–π
            if (item.link && item.link.length > 5) return 'planted';
            
            // –°—Å—ã–ª–∫–∏ –Ω–µ—Ç, –Ω–æ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –ø—Ä–æ—à–ª–∞ -> –ñ–µ–ª—Ç—ã–π
            if (dateObj <= today) return 'work';
            
            // –ë—É–¥—É—â–µ–µ -> –°–µ—Ä—ã–π
            return 'future';
        }

        // 8. –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞
        function renderList() {
            const listContainer = document.getElementById('dynamics-list');
            const summaryContainer = document.getElementById('summary-text');
            listContainer.innerHTML = '';

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –ú–µ—Å—è—Ü + –û—Ç—Ä–∞—Å–ª—å
            let filtered = allData.filter(item => {
                const d = parseDate(item.dateStr);
                const isMonthMatch = d.getMonth() === currentMonth;
                const isIndustryMatch = currentIndustry === '–í—Å–µ' || item.industry === currentIndustry;
                return isMonthMatch && isIndustryMatch;
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
            filtered.sort((a, b) => parseDate(a.dateStr) - parseDate(b.dateStr));

            let stats = { planted: 0, work: 0, future: 0 };

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –∑–∞–¥–∞—á –Ω–µ—Ç</div>';
            } else {
                filtered.forEach(item => {
                    const dateObj = parseDate(item.dateStr);
                    const status = getStatus(item, dateObj);
                    stats[status]++;

                    const card = document.createElement('div');
                    card.className = `dynamic-card status-${status}`;
                    
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ü–æ—Å–∞–∂–µ–Ω–æ", –¥–µ–ª–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–æ–π
                    const nameHtml = status === 'planted' 
                        ? `<a href="${item.link}" target="_blank">${item.name}</a>` 
                        : item.name;

                    card.innerHTML = `
                        <div class="date-col">${dateObj.getDate()}</div>
                        <div class="info-col">
                            <h4>${nameHtml}</h4>
                            <p>${item.industry}</p>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–≤–æ–¥–∫–∏
            summaryContainer.innerHTML = `
                –í—Å–µ–≥–æ –∑–∞–¥–∞—á: <b>${filtered.length}</b><br>
                <span style="color:var(--green)">‚óè –ì–æ—Ç–æ–≤–æ: ${stats.planted}</span> &nbsp; 
                <span style="color:var(--yellow)">‚óè –í —Ä–∞–±–æ—Ç–µ: ${stats.work}</span> &nbsp;
                <span style="color:var(--grey)">‚óè –ü–ª–∞–Ω: ${stats.future}</span>
            `;
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
